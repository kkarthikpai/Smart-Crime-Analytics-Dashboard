<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Police District Analytics Dashboard</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; 
        }
        #map {
            height: 400px;
            width: 100%;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        /* Navigation Bar Styles (Consistent Across Project) */
        .navbar { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            background: #1a237e; 
            padding: 10px 20px; 
            color: white; 
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); 
            position: sticky; 
            top: 0; 
            z-index: 20; 
        }
        .navbar h1 { margin: 0; font-size: 24px; font-weight: 600; }
        .nav-links { display: flex; gap: 25px; }
        .nav-links a { color: white; text-decoration: none; font-size: 16px; transition: color 0.3s; }
        .nav-links a:hover { color: #a5d6a7; }
        .dropdown { position: relative; display: inline-block; }
        .dropbtn { background: none; border: none; color: white; font-size: 16px; cursor: pointer; padding: 0; }
        .dropdown-content { display: none; position: absolute; background: white; min-width: 200px; box-shadow: 0px 8px 16px rgba(0,0,0,0.2); z-index: 10; right: 0; }
        .dropdown-content a { color: #333; padding: 12px 16px; text-decoration: none; display: block; }
        .dropdown-content a:hover { background: #e0e0e0; }
        .dropdown:hover .dropdown-content { display: block; }
    </style>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
</head>
<body class="p-0">
    
    <div class="navbar">
        <h1>Smart Crime Analytics Dashboard</h1>
        <div class="nav-links">
            <a href="index.html">Home</a>
            <div class="dropdown">
                <button class="dropbtn">Analytics â–¼</button>
                <div class="dropdown-content">
                    <a href="yearly_trend.html">Crime Trend (Yearly)</a>
                    <a href="top_crimes.html">Top Crime Types</a>
                    <a href="top_cities.html">City Hotspots</a>
                    <a href="district_analysis.html" style="background: #e0e0e0; color: #1a237e; font-weight: bold;">District Analysis</a> 
                </div>
            </div>
            <a href="about.html">About</a>
        </div>
    </div>

    <div class="p-4 md:p-8">
        <header class="mb-8 p-6 bg-white shadow-lg rounded-xl">
            <h1 class="text-3xl font-extrabold text-gray-900 mb-2">Police District Analytics Dashboard</h1>
            <p class="text-gray-600 mb-4">View key crime statistics, trends, and hotspots for any selected district.</p>
                    
            <div class="flex flex-col sm:flex-row items-start sm:items-center space-y-3 sm:space-y-0 sm:space-x-4">
                <label for="district-selector" class="text-lg font-semibold text-gray-700">Select District:</label>
                <select id="district-selector" 
                        class="p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 ease-in-out bg-white w-full sm:w-64">
                    <option value="" disabled selected>Loading Districts...</option>
                </select>
            </div>
        </header>

        <main id="dashboard-content" class="space-y-8 hidden">
            <section class="bg-indigo-50 border-t-4 border-indigo-500 rounded-xl p-6 shadow-xl">
                <h2 class="text-2xl font-bold text-indigo-800 mb-4 flex items-center">
                    <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    District Key Insights
                </h2>
                <div id="text-summary" class="prose max-w-none text-gray-700">
                </div>
            </section>
                    
            <section class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="bg-white p-6 rounded-xl shadow-lg hover:shadow-2xl transition duration-300">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">Annual Crime Trend (Last 5 Years)</h3>
                    <canvas id="annualTrendChart"></canvas>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-lg hover:shadow-2xl transition duration-300">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">Top 5 High-Crime Police Stations</h3>
                    <canvas id="topStationsChart"></canvas>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-lg hover:shadow-2xl transition duration-300">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">Case Resolution Status (FIR Stage)</h3>
                    <canvas id="resolutionStatusChart"></canvas>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-lg hover:shadow-2xl transition duration-300">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">Total Victim Demographics</h3>
                    <canvas id="victimDemographicsChart"></canvas>
                </div>
            </section>
            
            <section class="bg-white p-6 rounded-xl shadow-lg">
                <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                    <svg class="w-6 h-6 mr-2 text-red-500" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>
                    Crime Hotspot Map
                </h2>
                <div id="map"></div>
                <p class="mt-3 text-sm text-gray-500">Note: Data points are approximated to the Police Station centroid where actual coordinates were missing.</p>
            </section>
        </main>
    </div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <script>
        const ALL_CRIME_DATA = [
            // BAGALKOT Mock Data
            { District_Name: 'Bagalkot', FIR_Year: 2018, FIR_Stage: 'Convicted', UnitName: 'Mahalingapur PS', Male: 1, Female: 0, Boy: 0, Girl: 0, Latitude: 16.20, Longitude: 75.60, FIR_Type: 'Heinous', Accused_Count: 2, Arrested_Count: 0 },
            { District_Name: 'Bagalkot', FIR_Year: 2020, FIR_Stage: 'Undetected', UnitName: 'Mahalingapur PS', Male: 0, Female: 1, Boy: 0, Girl: 0, Latitude: 16.20, Longitude: 75.60, FIR_Type: 'Non Heinous', Accused_Count: 1, Arrested_Count: 1 },
            { District_Name: 'Bagalkot', FIR_Year: 2020, FIR_Stage: 'Pending Trial', UnitName: 'Teradal PS', Male: 1, Female: 0, Boy: 1, Girl: 0, Latitude: 16.35, Longitude: 75.30, FIR_Type: 'Heinous', Accused_Count: 3, Arrested_Count: 2 },
            { District_Name: 'Bagalkot', FIR_Year: 2021, FIR_Stage: 'Convicted', UnitName: 'Teradal PS', Male: 0, Female: 1, Boy: 0, Girl: 1, Latitude: 16.35, Longitude: 75.30, FIR_Type: 'Non Heinous', Accused_Count: 1, Arrested_Count: 1 },
            { District_Name: 'Bagalkot', FIR_Year: 2021, FIR_Stage: 'Dis/Acq', UnitName: 'Guledagudda PS', Male: 1, Female: 0, Boy: 0, Girl: 0, Latitude: 16.03, Longitude: 75.76, FIR_Type: 'Heinous', Accused_Count: 2, Arrested_Count: 1 },
            { District_Name: 'Bagalkot', FIR_Year: 2022, FIR_Stage: 'Undetected', UnitName: 'Mahalingapur PS', Male: 0, Female: 0, Boy: 1, Girl: 0, Latitude: 16.20, Longitude: 75.60, FIR_Type: 'Non Heinous', Accused_Count: 1, Arrested_Count: 0 },
            { District_Name: 'Bagalkot', FIR_Year: 2022, FIR_Stage: 'Convicted', UnitName: 'Lokapur PS', Male: 1, Female: 0, Boy: 0, Girl: 0, Latitude: 16.15, Longitude: 75.40, FIR_Type: 'Heinous', Accused_Count: 1, Arrested_Count: 1 },
            { District_Name: 'Bagalkot', FIR_Year: 2023, FIR_Stage: 'Pending Trial', UnitName: 'Mahalingapur PS', Male: 0, Female: 1, Boy: 0, Girl: 0, Latitude: 16.20, Longitude: 75.60, FIR_Type: 'Non Heinous', Accused_Count: 2, Arrested_Count: 1 },
            { District_Name: 'Bagalkot', FIR_Year: 2023, FIR_Stage: 'Pending Trial', UnitName: 'Lokapur PS', Male: 1, Female: 0, Boy: 0, Girl: 0, Latitude: 16.15, Longitude: 75.40, FIR_Type: 'Heinous', Accused_Count: 1, Arrested_Count: 1 },
            // KALABURAGI Mock Data
            { District_Name: 'Kalaburagi', FIR_Year: 2019, FIR_Stage: 'Convicted', UnitName: 'Jewargi PS', Male: 1, Female: 0, Boy: 0, Girl: 0, Latitude: 17.20, Longitude: 76.80, FIR_Type: 'Non Heinous', Accused_Count: 5, Arrested_Count: 3 },
            { District_Name: 'Kalaburagi', FIR_Year: 2020, FIR_Stage: 'Undetected', UnitName: 'Sedam PS', Male: 0, Female: 1, Boy: 0, Girl: 0, Latitude: 17.00, Longitude: 77.00, FIR_Type: 'Heinous', Accused_Count: 2, Arrested_Count: 0 },
            { District_Name: 'Kalaburagi', FIR_Year: 2021, FIR_Stage: 'Pending Trial', UnitName: 'Jewargi PS', Male: 1, Female: 0, Boy: 1, Girl: 0, Latitude: 17.20, Longitude: 76.80, FIR_Type: 'Heinous', Accused_Count: 3, Arrested_Count: 1 },
            { District_Name: 'Kalaburagi', FIR_Year: 2022, FIR_Stage: 'Convicted', UnitName: 'Sedam PS', Male: 0, Female: 1, Boy: 0, Girl: 1, Latitude: 17.00, Longitude: 77.00, FIR_Type: 'Non Heinous', Accused_Count: 1, Arrested_Count: 1 },
            { District_Name: 'Kalaburagi', FIR_Year: 2023, FIR_Stage: 'Dis/Acq', UnitName: 'Alland PS', Male: 1, Female: 0, Boy: 0, Girl: 0, Latitude: 17.50, Longitude: 77.20, FIR_Type: 'Heinous', Accused_Count: 2, Arrested_Count: 1 },
            { District_Name: 'Kalaburagi', FIR_Year: 2023, FIR_Stage: 'Undetected', UnitName: 'Jewargi PS', Male: 0, Female: 0, Boy: 1, Girl: 0, Latitude: 17.20, Longitude: 76.80, FIR_Type: 'Non Heinous', Accused_Count: 1, Arrested_Count: 0 },
        ];                
        let crimeMap = null;        
        let chartInstances = {}; 
        
        document.addEventListener('DOMContentLoaded', () => {            
            const selector = document.getElementById('district-selector');            
            const districts = [...new Set(ALL_CRIME_DATA.map(d => d.District_Name))].sort();            
            selector.innerHTML = '<option value="" disabled selected>Select a District</option>';            
            districts.forEach(district => {                
                const option = document.createElement('option');                
                option.value = district;                
                option.textContent = district;                
                selector.appendChild(option);            
            });            
            selector.addEventListener('change', (e) => {                
                const selectedDistrict = e.target.value;                
                if (selectedDistrict) {                    
                    document.getElementById('dashboard-content').classList.remove('hidden');                    
                    renderDashboard(selectedDistrict);                
                }            
            });        
        });        

        function renderDashboard(districtName) {            
            const districtData = ALL_CRIME_DATA.filter(d => d.District_Name === districtName);                        
            const report = generateDistrictReportJS(districtName, districtData);            
            document.getElementById('text-summary').innerHTML = parseMarkdown(report.text_summary);            
            renderAnnualTrendChart(report.analysis.annualTrend);            
            renderTopStationsChart(report.analysis.topStations);            
            renderResolutionStatusChart(report.analysis.resolutionStatus);            
            renderVictimDemographicsChart(report.analysis.victimDemographics);            
            renderCrimeMap(report.data_for_map);        
        }                

        function generateDistrictReportJS(districtName, df_district) {            
            const totalFirs = df_district.length;            
            const years = df_district.map(d => d.FIR_Year);            
            const latestYear = Math.max(...years);            
            const previousYear = latestYear - 1;            
            const firsByYear = df_district.reduce((acc, d) => {                
                acc[d.FIR_Year] = (acc[d.FIR_Year] || 0) + 1;                
                return acc;            
            }, {});                        
            const latestYearFirs = firsByYear[latestYear] || 0;            
            const previousYearFirs = firsByYear[previousYear] || 0;                        
            const yoyChange = previousYearFirs > 0                 
                ? ((latestYearFirs - previousYearFirs) / previousYearFirs) * 100                 
                : (latestYearFirs > 0 ? 100 : 0);                        
            const yoyStatement = `${yoyChange > 0 ? 'an increase' : 'a decrease'} of ${Math.abs(yoyChange).toFixed(1)}%.`;            
            
            const unitCounts = df_district.map(d => d.UnitName).reduce((acc, name) => {                
                acc[name] = (acc[name] || 0) + 1;                
                return acc;            
            }, {});            
            const sortedUnits = Object.entries(unitCounts).sort(([, a], [, b]) => b - a);            
            const topUnits = sortedUnits.slice(0, 3).map(([name]) => name);            
            const top5Stations = sortedUnits.slice(0, 5);            
            
            const firStageCounts = df_district.map(d => d.FIR_Stage).reduce((acc, stage) => {                
                acc[stage] = (acc[stage] || 0) + 1;                
                return acc;            
            }, {});            
            
            const victimDemographics = df_district.reduce((acc, d) => {                
                acc['Adult Male'] += d.Male;                
                acc['Adult Female'] += d.Female;                
                acc['Juvenile Male'] += d.Boy;                
                acc['Juvenile Female'] += d.Girl;                
                return acc;            
            }, { 'Adult Male': 0, 'Adult Female': 0, 'Juvenile Male': 0, 'Juvenile Female': 0 });                        
            
            const totalAccused = df_district.reduce((sum, d) => sum + d.Accused_Count, 0);            
            const totalArrested = df_district.reduce((sum, d) => sum + d.Arrested_Count, 0);            
            const arrestRate = totalAccused > 0 ? (totalArrested / totalAccused) * 100 : 0;                        
            
            const heinousFirs = df_district.filter(d => d.FIR_Type === 'Heinous').length;            
            const heinousPercent = totalFirs > 0 ? (heinousFirs / totalFirs) * 100 : 0;            
            
            const convictionRate = (firStageCounts['Convicted'] || 0) / totalFirs * 100;            
            const undetectedRate = (firStageCounts['Undetected'] || 0) / totalFirs * 100;                        
            
            const textSummary = `                
                <h3 class="text-xl font-bold mb-3 text-indigo-700">${districtName} District: Performance Overview</h3>                                
                <p><strong>1. Crime Volume and Trends:</strong></p>
                <ul class="list-disc list-inside ml-4 space-y-1">                    
                    <li>Total FIRs (since 2016): <span class="font-bold text-gray-900">${totalFirs.toLocaleString()}</span></li>                    
                    <li>Latest Annual Change (${previousYear} to ${latestYear}): There was ${yoyStatement} in FIR volume, totaling ${latestYearFirs.toLocaleString()} cases last year.</li>
                </ul>                
                <p class="mt-3"><strong>2. Severity and Resolution:</strong></p>
                <ul class="list-disc list-inside ml-4 space-y-1">                    
                    <li>Heinous Crime Rate: <span class="font-bold text-red-600">${heinousPercent.toFixed(1)}%</span> of all cases were classified as Heinous.</li>                    
                    <li>Case Resolution: The district's current conviction rate stands at <span class="font-bold text-green-600">${convictionRate.toFixed(1)}%</span>, with <span class="font-bold text-yellow-600">${undetectedRate.toFixed(1)}%</span> of all cases remaining Undetected (no closure).</li>                    
                    <li>Arrest Efficiency: The overall arrest rate is <span class="font-bold text-indigo-600">${arrestRate.toFixed(1)}%</span> (total arrests vs. total accused count).</li>
                </ul>                
                <p class="mt-3"><strong>3. High-Risk Zones:</strong></p>
                <ul class="list-disc list-inside ml-4 space-y-1">                    
                    <li>Top 3 High-Crime Police Stations (by volume): <span class="font-bold">${topUnits.join(', ')}</span></li>
                </ul>            
            `;                        
            
            return {                
                text_summary: textSummary,                
                analysis: {                    
                    annualTrend: firsByYear,                    
                    topStations: top5Stations,                    
                    resolutionStatus: firStageCounts,                    
                    victimDemographics: victimDemographics                
                },                
                data_for_map: df_district.map(d => ({ lat: d.Latitude, lng: d.Longitude, type: d.FIR_Type, unit: d.UnitName }))            
            };        
        }        

        function destroyChart(chartId) {            
            if (chartInstances[chartId]) {                
                chartInstances[chartId].destroy();                
                delete chartInstances[chartId];            
            }        
        }                
        
        function renderAnnualTrendChart(data) {            
            destroyChart('annualTrendChart');            
            const years = Object.keys(data).sort();            
            const firs = years.map(year => data[year]);            
            const ctx = document.getElementById('annualTrendChart').getContext('2d');            
            chartInstances['annualTrendChart'] = new Chart(ctx, {                
                type: 'line',                
                data: {                    
                    labels: years,                    
                    datasets: [{                        
                        label: 'Total FIRs',                        
                        data: firs,                        
                        backgroundColor: 'rgba(52, 152, 219, 0.2)',                        
                        borderColor: '#3498db',                        
                        borderWidth: 3,                        
                        pointBackgroundColor: '#2c3e50',                        
                        tension: 0.4,                    
                    }]                
                },                
                options: {                    
                    responsive: true,                    
                    plugins: {                        
                        legend: { display: false },                        
                        title: { display: false }                    
                    },                    
                    scales: {                        
                        y: { beginAtZero: true, title: { display: true, text: 'FIR Count' } }                    
                    }                
                }            
            });        
        }        
        
        function renderTopStationsChart(data) {            
            destroyChart('topStationsChart');            
            const labels = data.map(([name]) => name);            
            const values = data.map(([, count]) => count);            
            const ctx = document.getElementById('topStationsChart').getContext('2d');            
            chartInstances['topStationsChart'] = new Chart(ctx, {                
                type: 'bar',                
                data: {                    
                    labels: labels,                    
                    datasets: [{                        
                        label: 'FIR Count',                        
                        data: values,                        
                        backgroundColor: [                            
                            '#e74c3c', 
                            '#e67e22',                             
                            '#f1c40f',                             
                            '#3498db',                            
                            '#2ecc71',                        
                        ],                        
                        borderColor: '#34495e',                        
                        borderWidth: 1                    
                    }]                
                },                
                options: {                    
                    responsive: true,                    
                    indexAxis: 'y', 
                    plugins: {                        
                        legend: { display: false },                        
                        title: { display: false }                    
                    },                    
                    scales: {                        
                        x: { beginAtZero: true, title: { display: true, text: 'FIR Count' } }                    
                    }                
                }            
            });        
        }                
        
        function renderResolutionStatusChart(data) {            
            destroyChart('resolutionStatusChart');            
            const labels = Object.keys(data);
            const values = Object.values(data);                        
            const ctx = document.getElementById('resolutionStatusChart').getContext('2d');            
            chartInstances['resolutionStatusChart'] = new Chart(ctx, {                
                type: 'doughnut',                
                data: {                    
                    labels: labels,                    
                    datasets: [{                        
                        data: values,                        
                        backgroundColor: [                            
                            '#2ecc71', 
                            '#3498db', 
                            '#f39c12', 
                            '#95a5a6',                       
                        ],                        
                        hoverOffset: 4                    
                    }]                
                },                
                options: {                    
                    responsive: true,                    
                    plugins: {                        
                        legend: { position: 'bottom' },                        
                        title: { display: false }                    
                    }                
                }            
            });        
        }        
        
        function renderVictimDemographicsChart(data) {            
            destroyChart('victimDemographicsChart');            
            const labels = Object.keys(data);
            const values = Object.values(data);                        
            const ctx = document.getElementById('victimDemographicsChart').getContext('2d');            
            chartInstances['victimDemographicsChart'] = new Chart(ctx, {                
                type: 'pie',                
                data: {                    
                    labels: labels,                    
                    datasets: [{                        
                        data: values,                        
                        backgroundColor: [                            
                            '#3498db', 
                            '#e74c3c', 
                            '#1abc9c', 
                            '#9b59b6', 
                        ],                        
                        hoverOffset: 4                    
                    }]                
                },                
                options: {                    
                    responsive: true,                    
                    plugins: {                        
                        legend: { position: 'bottom' },                        
                        title: { display: false }                    
                    }                
                }            
            });        
        }                
        
        function renderCrimeMap(mapData) {            
            const mapElement = document.getElementById('map');                        
            if (crimeMap) {                
                crimeMap.remove();            
            }
            if (mapData.length === 0) {                
                mapElement.innerHTML = '<p class="text-center text-gray-500 p-10">No geo-data available for this district.</p>';                
                return;            
            }                        
            const latitudes = mapData.map(d => d.lat);            
            const longitudes = mapData.map(d => d.lng);            
            const centerLat = latitudes.reduce((a, b) => a + b, 0) / latitudes.length;            
            const centerLng = longitudes.reduce((a, b) => a + b, 0) / longitudes.length;                        
            
            crimeMap = L.map('map').setView([centerLat, centerLng], 10);                        
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {                
                maxZoom: 18,                
                attribution: 'Â© OpenStreetMap contributors'            
            }).addTo(crimeMap);            
            
            const getColor = (type) => type === 'Heinous' ? 'red' : 'blue';                        
            
            mapData.forEach(item => {                
                const color = getColor(item.type);                
                const icon = L.divIcon({                    
                    className: 'custom-div-icon',                    
                    html: `<div style="background-color:${color}; width: 15px; height: 15px; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 5px ${color};"></div>`,                    
                    iconSize: [15, 15],                    
                    iconAnchor: [7, 7]                
                });                                
                L.marker([item.lat, item.lng], {icon: icon})                    
                    .bindPopup(`<b>Station:</b> ${item.unit}<br><b>Type:</b> ${item.type}`)                    
                    .addTo(crimeMap);            
            });        
        }        

        function parseMarkdown(text) {            
            let html = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); 
            html = html.replace(/<ul class="list-disc list-inside ml-4 space-y-1">/g, '<ul>'); 
            return html;        
        }    
    </script>
</body>
</html>